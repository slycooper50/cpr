% From mitthesis package
% Version: 1.04, 2023/10/19
% Documentation: https://ctan.org/pkg/mitthesis
\chapter{Introduction}
The use of models is part of our everyday life. In our modern society, we are sourounded by a myriad of complex systems that are
essential for the workings of our lifes from transportation, communication and food processing to energy production. Scientis and engineers
handle complexity by building simplified models that can be further enhanced to increase their ability to describe the complex systems.
In the petroleum industry, reservoir simulation is a branch of reservoir engineering that aims to develop models of the petroleum systems.
These models are built using knowledge of geological, geophysical and petrophysical properties of the petroleum reservoir system.
They are routinely used to describe fluid flow during the phase of field development planning and production, which enable the engineers 
to develop an optimum field production plan. The importance of reservoir simulation stems from the complexity of the physical systems that reservoir 
engineers attempt to describe. The use of mathematical models is essential to provide precise and valuable answers to the questions the simulator is 
set to answer. 

\begin{figure}[htb]
\centering
\resizebox{15cm}{!}{\input{tikz/models.tikz}}
\caption{Models used in a reservoir simulator.}\label{models}
\end{figure}

There are several physical systems within a petroleum reservoir that a reservoir simulator needs to model. 
These can include the grid dimensions representing the reservoir and the geological properties of the reservoir such as porosity, 
permeability and multiphase fluid flow parameters like capillary pressure and relative permeability. A fluid flow model that consists of 
conservation laws and a constitutive Darcy's law for flow in porous media must also be incorporated as a model to the reservoir simulator.
Several fluid modeling techniques are used in the industry, the most commonly known are the \textit{Black-oil} and \textit{Compositional} models.
Moreover, the boundary conditions for the differential equations describing the fluid flow are the wells, both injectors and producers. 
The wells are also routinely modeled in the simulator using differential equations to describe inflow performance of the wells. One of well models
main objectives is to relate the reservoir gridblock pressure to the well bottom hole pressure. More sophisticated well models handle cross flow and
multilateral, horizontal and slanted wells. Reservoir simulators can also include additional models to simulate networks of fractures, surface facilities,
enhanced oil recovery and geomechanics. The main standard models that a simple reservoir simulator must incorporate are summarized in figure \ref{models}.

The inner components of reservoir simulators are more or less universal. Each simulator has to support a 
gridding infrastructure to support discretization of the simulation domain, a nonlinear solver (usually based on Newton's Method) to 
solve the nonlinear coupled PDEs of fluid flow, a linear solver that will solve the matrix produced by the nonlinear solver, a timestepping
mechanism guided by some convergence criteria of the nonlinear solver and an I/O system to generate results requested by the user for post-processing.

At the \textit{Center for Subsurface Energy and the Environment}, there are three variants of reservoir simulators. The full-fledged compositional 
simulator \texttt{UTCOMPRS} is capable of handling up to four-phase flow, an aqueous, oleic, gaseous and an additional nonaqueous liquid phase. 
The simulator was originally developed in the 1990s\supercite{utcomp}. The second simulator \texttt{UTCHEMRS}, is specialized in chemical flooding.
\texttt{UTCOMPRS} and \texttt{UTCHEMRS} supports an Adaptive-Implicit formulation, with gridding supported by both Cartesian and the industry standard
Corner-Point Geometry. The third \texttt{Multi-Purpose Simulator (MPS)} is focused on performing parallel simulation for large complex reservoirs operating under
various recovery processes. The modeling group maintains the development of all three simulators. 

The overall algorithm of a reservoir simulator can be simplified by focusing on the essential components. These will be found in every reservoir simulator, whether
its foucsed on research or industrial activities. The simulation process is depicted in figure \ref{simulator}. The process commences by parsing the input files that describe the
reservoir and boundary conditions as specified by wells or aquifers. Then an algroithm to build the simulation grid is run and connectivity graph is constructed. Then the three main
loops of the simulator are entered. These loops consist of a time loop that will finish once the end of specified simulation time is reached. The second inner loop is Newtonian loop,
that will end once the set of nonlinear equations are solved with acceptable tolerance. The third inner loop is the linear solver loop that will finish once the linear system of equations
is solved with acceptable tolerance.

\begin{figure}[htb]
\raggedright
\resizebox{15cm}{!}{\input{tikz/simulator.tikz}}
\caption{Generic Algorithm Of A Reservoir Simulator.}\label{simulator}
\end{figure}
\clearpage

A crucial advantage of simulation tools over classical engineering analysis practices is the ability
to perform a large number of calculations in an efficient way. In reservoir simulation, the most taxing
component of runing a simulator is usually the linear solver. Therefore, research in developing efficient
techniques in solving large system of equations is ample in the reservoir simulation literature. The main
focus is usually on developing scalable preconditioners that can be combined with iterative Krylov-based 
iterators. The industry standard preconditioner is the Constrained Pressure Residual. This preconditioner
has its roots in the works of Wallis\supercite{Wallis_1983,Wallis_1985}, the essential idea relies on decoupling
the resulting system of linear equations by isolating the elliptic dominant part of the system (pressure) from 
the hyperbolic (saturation or concentration) part of the system. 

The convergance of a Krylov iterative solver depends essentially on the preconditioner. The prototypical Krylov method, the
Conjugate Gradient can handle Symmetric-Positive-Definite matrices. For reservoir simulation cases, where matrices are ill-conditioned and
not symmetric, the Generalized Minimum Residual \textit{GMRES}, is used\supercite{roy}. 

\section{Spatial Discretization}
The discretization techniques consist an active area of research in numerical solution of PDEs. Historically reservoir simulators used 
finite-difference method to discretize the nonlinear PDE system. The current generation of reservoir simulators, both originating from
academy and industry, utilize the Two-Point Flux-Approximation (TPFA), which is based on a finite volume method. Finit-volume mehthods 
originate from a physically motivated conservation law. A more accurate method for high-resolution grids with non-orthogonal oriented 
grids with respect to the permeability tensor is the Multi-Point Flux-Approximation (MPFA) \cite{mpfa}. TPFA is not consistent for grids
that are not K-orthogonal and a more accurate discretization technique must be used. In this brief description the discussion will be
restricted the simple case of orthogonal grids and the TPFA will be discussed. 

The formulation used in \texttt{UTCOMPRS} can be described by the following system of PDEs\supercite{phdfernandes}:
\begingroup\makeatletter\def\f@size{12}\check@mathfonts
\begin{equation}
	\begin{cases}
		\frac{1}{V_{b}} \frac{\partial N_{k}}{\partial t} = \sum_{j=2}^{n_{p}}\Big\{\nabla \cdot\Big( x_{kj}\xi_{j}\frac{k_{rj}}{\mu_{j}}\tensor{K}\cdot\nabla\Phi_{j}\Big) + \nabla \cdot \Big(\phi S_{j}\xi_{j}\tensor{\Lambda}_{kj}\cdot\nabla x_{kj}\Big)\Big\} - \frac{q_{k}}{V_{b}}, \ k=1,...,n_{c}\\\\
		\frac{1}{V_{b}} \frac{\partial N_{w}}{\partial t} = \nabla \cdot \Big(\xi_{w}\frac{k_{rw}}{\mu_{w}}\tensor{K}\cdot \nabla\Phi_{w}\Big) - \frac{q_{w}}{V_{b}}
	\end{cases}
\end{equation}\endgroup

\begin{figure}[htb]
\raggedright
\resizebox{13cm}{!}{\input{tikz/tpfa.tikz}}
\caption{Two-Point Flux-Approximation.}\label{tpfa}
\end{figure}



\section{Temporal Discretization}
The discretization of the time variable is of significant importance to the overall solution procedure.
Explicit and implicit methods are used to treat the time derivative. The implicit procedure produces the 
system of equations that needs to be solved, while the explicit technique results in a problem that can be
solved sequentially. The explicit method can compute the state of the system at time $n+1$ exclusively from 
variables evaluated at time level $n$. While the implicit method constructs an equation for variables at level
$n+1$ that involves both variables at level $n$ and $n+1$. Mathematically the two techniques can be represented by 
the following, if $Y(t)$ represents the state of the system at time $t$:
\begingroup\makeatletter\def\f@size{12}\check@mathfonts
\begin{equation}
	\begin{cases}
		Y(t+\Delta t) = F(Y(t)), \ \text{(Explicit scheme)}\\\\
		G(Y(t), Y(t+\Delta t)) = 0, \ \text{(Implicit scheme)}\\\\
		Y(t+\Delta t) = F(Y(t+\Delta t)) + G(Y(t)), \ \text{(Mixed scheme)}
	\end{cases}
\end{equation}\endgroup
The explicit methods are easier to implement, but their fallout is a severe restriction on timestep size, 
requiring a small timestep to converge. Implicit methods on the other hand, will result in large systems of 
equations that will take time to solve, but they allow for the selection of large timestep sizes resulting in 
overall outperformance to the explicit methods. In the reservoir simulation literature, there exists a variety of
different types of time discretization, with special emphasis on implicit and mixed (implicit on stiff variables and explicit on others) 
discretization techniques. In \texttt{UTCOMPRS}, extensive research was conducted to implement several formulations. Each formulation treats
different variables with different degrees of implicitness. A summary of the most important formulations is give in table \ref{formulations}.
Below an example of discretizing the water equation from the system of PDEs is given for illustration.

\begin{table}[h]
	\begin{threeparttable}
	\centering
	\resizebox{\columnwidth}{!}{%
	\begin{tabular*}{1.2\textwidth}{@{\extracolsep{\fill}} l|c|c|l}
		\toprule
		Formulation Name & Implicitness Degree\textsuperscript{$\dag$} & Iterative Method \textsuperscript{$\ddag$}& Primary Variables\\
		\midrule
		Fussel \& Fussel\supercite{fussel} & IMPEC & MVNM & $\{p, N_{g}, x_{2g}, ..., x_{n_{c}g}\}$\\
		Coats\supercite{coats} & FI & NM & $\{p_{g}, S_{o} ,S_{g}, x_{3g}, ..., x_{n_{c}g}\}$ \\
		Nghiem et al.\supercite{nghiem} & IMPEC & NM & $\{p, N_{w}, N_{h}, z_{1}, ..., z_{n_{c}}\}$\\
		Young \& Stephenson\supercite{ys} & IMPEC & NM & $\{p, N_{w}, N_{h}, L_{g}, z_{1}, ..., z_{n_{c}-1}\}$\\
		Chien et al.\supercite{chien} & FI & NM & $\{p, N_{w}, N_{1}, ..., N_{n_{c}}\}$\\
		\'Acs et al.\supercite{acs} & IMPEC & OI & $\{p, N_{w}, N_{1}, ..., N_{n_{c}}\}$\\
		Watts\supercite{watts} & IMPSAT & SOI & $\{p, S_{o}, S_{g}, N_{w}, N_{1}, ..., N_{n_{c}}\}$\\
		Quandalle\supercite{quandalle} \& Savary & IMPSAT & SOI & $\{p, S_{w}, S_{g}, x_{2o}, ..., x_{n_{c}-1o}\}$\\
		Collins et al.\supercite{collins} & AIM/FI/IMPEC & NM & $\{p, N_{w}, N_{1}, ..., N_{n_{c}}\}$\\
		Branco \& Rodriguez\supercite{branco} & IMPSAT & NM & $\{p, S_{w}, S_{g}, x_{1o}, ..., x_{n_{c}-2o}\}$\\
		Wang et al.\supercite{wang} & FI & NM & $\{p, N_{w}, N_{1}, ..., N_{n_{c}}, \ln{(K_{1})}, ..., \ln{(K_{n_{c}})}\}$\\
		Haukas et al.\supercite{haukas} & IMPSAT & SOI & $\{p, S_{w}, S_{g}, \kappa_{1}..., \kappa_{n_{c}-n_{p}}\}$\\
		Ayala\supercite{ayala} & FI & QNM & $\{p, S_{w}, z_{1}, ..., z_{n_{c}-1}\}$\\
		Fernandes et al.\supercite{batista} & FI & NM & $\{p, S_{w}, z_{1}, ..., z_{n_{c}-1}\}$\\
		\bottomrule
	\end{tabular*}
	}
	\caption{Summary of the most important formulations in compositional reservoir simulation \cite{phdfernandes}.}
	\label{formulations}
	\begin{tablenotes}
	\small
	\item [\textsuperscript{$\dag$}] FI: Fully-Implicit. IMPEC: Implicit-Pressure Explicit-Concentration. AIM: Adaptive-Implicit.\\
		\phantom{x}\hspace{0.1cm}IMPSAT: Implicit-Pressure and Saturation Explicit-Mole Fraction.
	\item [\textsuperscript{$\ddag$}] NW: Newton's Method. QNM: Quasi-Newton's Method. MVNM: Minimum Variable Newton's Method.\\
		\phantom{x}\hspace{0.1cm} OI: One-Iteration. SOI: Sequential with One-Iteration.
	\end{tablenotes}
	\end{threeparttable}
\end{table}%

\section{Nonlinear Equations Solution Method}

\section{Linear System Solution Method}
The Newton's method can be considered as a linearization tool that produce a large system of linear equations $Ax = b$.
This system of equations must be solved to obtain the vector of increments $x$ that guide the changes to the solution vector.
The linear solver is the computational engine of the simulator and it is almost always the most taxing part of the simulator
for all cases. The ability to make various engineering studies rely on the ability to run the simulator several times in a 
reasonable amount of time. Therefore, in the computational science community in general, and in reservoir simulation in particular 
there is a vast amount of research to develop faster and scalable linear solver. This development continuously take advantage of
latest software and hardware developements. The history of this topic in numerical analysis is very rich. In reservoir simulation,
some early efforts to tailor a solver for reservoir simulators started with work on direct methods \cite{direct}.
For large systems, it became very clear that direct methods are not capable of competing with iterative methods.
One of the first iterative methods to be researched in the reservoir simulation community is the \texttt{Orthomin} method \cite{orthomin}.
The method to be used with reservoir simulators must be robust with systems that pose no-symmetry and are very ill-conditioned.
Another iterative method developed in the 80s is the \texttt{Nested Factorization} \cite{nested}. This method is still in use in the 
\texttt{Eclipse} commercial simulator. The \texttt{Nested Factorization} algorithm is mainly used as a preconditioner for the conjugate gradient
and \texttt{Orthomin} solvers. The focus of research on linear solvers is on computing speed and storage requirements. 
The latest type of iterative solvers that is currently being used in almost all reservoir simulators are the Krylov based solvers (\texttt{GMRES} being the most popular \cite{gmres}).
These Krylov based solvers are covered thoroughly in \cite{saad}. The current efforts of investigations on linear solvers in the reservoir simulation community
has been on attempts to program the most efficient techniques to run on \textit{Graphics Processing Units} \cite{appleyardgpu, gpunested}.
This report will present a preconditioner that is meant to be used with a Krylov based solver to accelerate the convergance of linear system solution.
